<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>MVVM 双向绑定</title>
</head>

<body>

    <div id="app">
        <h1>{{name}} 's age is {{age}}</h1>
        <input v-model="name" type="text">
    </div>
    <script>

        function observe(data) {
            if (!data || typeof data !== 'object') return
            for (var key in data) {
                let val = data[key]
                //  立马创建主题
                let subject = new Subject()
                Object.defineProperty(data, key, {
                    configable: true,
                    enumerable: true,
                    get: function () {
                        console.log(`get ${key}: ${val}`)
                        //---!!---
                        if (currentObserver) {
                            currentObserver.subscribeTo(subject)
                        }
                        return val
                    },
                    set: function (newVal) {
                        val = newVal

                        //通知更新
                        subject.notify()
                    }
                })
                if (typeof val === 'object') {
                    observe(val)
                }
            }
        }  //监听函数
        let id = 0
        let currentObserver = null
        //主题
        class Subject {
            constructor() {
                this.observers = []
                this.id = id++
            }
            addObserver(observer) {
                this.observers.push(observer)
            }
            deleteObesever(observer) {
                let index = this.observes.indexOf(observer)
                if (index > -1) { this.observers.splice(index, 1) }

            }
            notify() {
                this.observers.forEach((observer) => {
                    observer.update()
                })
            }
        }       //定义一个主题，里面包含了增删通知观察者，三个操作
        class Observer {
            constructor(vm, key, callback) {
                this.subjects = {}
                this.vm = vm
                this.callback = callback
                this.key = key
                this.value = this.getVal()
            }
            subscribeTo(subject) {
                if (!this.subjects[subject.id]) {
                    subject.addObserver(this)
                    this.subjects[subject.id] = subject
                }

            }
            update() {
                let oldVal = this.value
                let value = this.getVal()
                if (oldVal !== value) {
                    this.value = value
                    this.callback.bind(this.vm)(value, oldVal)
                }
            }
            getVal() {
                currentObserver = this
                let value = this.vm.$data[this.key]
                currentObserver = null
                return value
            }
        }       //定义一个观察者，里面包含了订阅主题，收到通知来更新
        class mvvm {
            constructor(opt) {
                this.init(opt)
                observe(this.$data)
                this.compile(opt)
            }
            init(opt) {
                this.$data = opt.data || {}
                this.$el = document.querySelector(opt.el) 
                this.observers = []
                this.$methods = opt.methods || {}
                for (let key in this.$data){
                    Object.defineProperty(this,key,{
                        enumerable:true,
                        configurable:true,
                        get:()=>{
                            return this.$data[key]
                        },
                        set:newVal =>{
                            this.$data[key] = newVal
                        }
                    })
                }
                for(let key in this.$methods){//让 this.$methods 里面的函数中的 this，都指向当前的 this，也就是 vm
                    this.$methods[key] = this.$methods[key].bind(this)
                }
            }
            compile() {
                this.traverse(this.$el)   //遍历一遍
            }
            traverse(node) {
                if (node.nodeType === 1) {  //元素节点，我都要看看，里面有没有指令
                    this.renderNode(node)
                    node.childNodes.forEach((childNode) => {
                        this.traverse(childNode)
                    })

                } else if (node.nodeType === 3) { //纯文本
                    this.renderText(node)
                }
            }
            renderText(node) {
                //Reg
                let reg = /{{(.+?)}}/g
                let match
                while (match = reg.exec(node.nodeValue)) {
                    let raw = match[0]
                    let key = match[1].trim()
                    node.nodeValue = node.nodeValue.replace(raw, this.$data[key])
                    new Observer(this, key, function (val, oldVal) {
                        node.nodeValue = node.nodeValue.replace(oldVal, val)
                    })
                }
            }
            //处理指令
            renderNode(node) {
                let attrs = [...node.attributes] //类数组对象转换成对象
                attrs.forEach(attr => {  //attr.name 是属性的名字 如v-model ,attr.value就是name
                    if (this.isModelDirective(attr.name)) {
                        this.bindModel(node, attr)
                    }
                    else if (this.isEventDirective(attr.name)) {
                        this.bindEventHandler(node, attr)
                    }
                })
            }
            bindModel(node, attr) {
                let key = attr.value
                node.value = this.$data[key]
                new Observer(this, key, function (newVal) {
                    node.nodeValue = newVal
                })
                node.oninput = (e) => {
                    this.$data[key] = e.target.value
                }
            }
            bindEventHandler(node, attr) {
                let eventType = attr.name.substr(5)   //attr.name='v-on:click' attr.value = 'sayHi'
                let methodName = attr.value
                node.addEventListener(eventType, this.$methods[methodName])
            }
            isDirective(attrName) {
                return attrName === 'v-model'
            }
            isEventDirective(attrName) {
                return attrName.indexOf('v-on') === 0
            }
        }          //mvvm框架，主要是查找并且替换


        let vm = new mvvm({
            el: '#app',
            data: {
                name: 'jirengu',
                age: 3
            },
            methods: {
                sayHi() {
                    alert(`hi ${this.name}`)
                }
            }
        })

        let clock = setInterval(function () {
            vm.age++   //等同于 vm.$data.age， 见 mvvm init 方法内的数据劫持

            if (vm.age === 10) clearInterval(clock)
        }, 1000)
    </script>
</body>

</html>